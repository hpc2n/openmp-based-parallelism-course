<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction to OpenMP (part 1) &mdash; OpenMP parallelism in scientific computing  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Introduction to OpenMP (part 2)" href="../openmp-basics2/" />
    <link rel="prev" title="Introduction to Kebnekaise" href="../setup/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            OpenMP parallelism in scientific computing
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Day 1</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hpc2n-intro/">Introduction to HPC2N</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Introduction to Kebnekaise</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction to OpenMP (part 1)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simple-example">Simple example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#openmp-pragmas-and-constructs">OpenMP pragmas and constructs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-construct">Parallel construct</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-sharing-rules">Data sharing rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="#explicit-data-sharing-rules">Explicit data sharing rules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../openmp-basics2/">Introduction to OpenMP (part 2)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../motivation/">Introduction to task-based parallelism</a></li>
<li class="toctree-l1"><a class="reference internal" href="../task-basics-1/">OpenMP task basics (part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../task-basics-2/">OpenMP task basics (part 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../task-basics-lu/">Example: LU factorization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../two-sided-algorithms/">Demonstration: Two-sided matrix algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starpu1/">StarPU runtime system (part 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starpu2/">StarPU runtime system (part 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../starpu-lu/">Example: LU factorization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Miscellanous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">OpenMP parallelism in scientific computing</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Introduction to OpenMP (part 1)</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/hpc2n/OpenMP-parallelism-course/blob/master/docs/openmp-basics1.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction-to-openmp-part-1">
<h1>Introduction to OpenMP (part 1)<a class="headerlink" href="#introduction-to-openmp-part-1" title="Permalink to this heading"></a></h1>
<p><a class="reference external" href="https://www.openmp.org/">OpenMP</a> (<em>Open Multi-Processing</em>) is a programming API for shared-memory parallel programming in C, C++, and Fortran languages.
It is based on <strong>pragmas</strong> or <strong>directives</strong> which augment the source code and change how a compiler processes the source code.
In case of OpenMP, the pragmas specify how the code is to be parallelized.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The Kebnekaise login and compute nodes have the <code class="code docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environmental variable set to <code class="code docutils literal notranslate"><span class="pre">1</span></code> by default.</p>
<ol class="arabic">
<li><p>If you are using the Kebnekaise login nodes to experiment with OpenMP, then it is important to set the <code class="code docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environmental variable to some reasonable value:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">8</span>
</pre></div>
</div>
</div></blockquote>
<p>Please note that you are not allowed to run long computations on the login nodes!</p>
</li>
<li><p>If you are using the Kebnekaise compute nodes to experiment with OpenMP, then either <strong>unset</strong> the <code class="code docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environmental variable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">unset</span><span class="w"> </span>OMP_NUM_THREADS
</pre></div>
</div>
<p>or, if you specified the <code class="code docutils literal notranslate"><span class="pre">--cpus-per-task=&lt;cpu</span> <span class="pre">count&gt;</span></code> SLURM argument, set the <code class="code docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environmental variable to the number of CPU cores available for the task:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="nv">$SLURM_CPUS_PER_TASK</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div>
<section id="simple-example">
<h2>Simple example<a class="headerlink" href="#simple-example" title="Permalink to this heading"></a></h2>
<p>Consider the following “Hello world” program:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">5</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">6</span><span class="p">}</span>
</pre></div>
</div>
<p>We can confirm that the code indeed behaves the way we expect:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-Wall
$<span class="w"> </span>./my_program
<span class="hll">Hello<span class="w"> </span>world!
</span></pre></div>
</div>
<p>Let us modify the program by adding an OpenMP pragma:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="linenos">4</span><span class="w">    </span><span class="cp">#pragma omp parallel</span>
</span><span class="linenos">5</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="linenos">6</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">7</span><span class="p">}</span>
</pre></div>
</div>
<p>This time the program behaves very differently (note the extra <code class="code docutils literal notranslate"><span class="pre">-fopenmp</span></code> compiler option):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-Wall<span class="w"> </span>-fopenmp
$<span class="w"> </span>./my_program
<span class="hll">Hello<span class="w"> </span>world!
</span><span class="hll">Hello<span class="w"> </span>world!
</span><span class="hll">...
</span><span class="hll">Hello<span class="w"> </span>world!
</span></pre></div>
</div>
<p>Clearly, the <code class="code docutils literal notranslate"><span class="pre">omp</span> <span class="pre">parallel</span></code> pragma caused the program to execute the <code class="code docutils literal notranslate"><span class="pre">printf</span></code> line <strong>several times</strong>.
If you go and try to execute the program on a different computer, you will observe that the number of lines printed is the same as the <strong>number of processor cores in the computer</strong>.
The <code class="code docutils literal notranslate"><span class="pre">-fopenmp</span></code> compiler option tells the compiler to expect OpenMP pragmas.</p>
</section>
<section id="openmp-pragmas-and-constructs">
<h2>OpenMP pragmas and constructs<a class="headerlink" href="#openmp-pragmas-and-constructs" title="Permalink to this heading"></a></h2>
<p>In C and C++, an OpenMP pragma has the following form:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp directive-name [clause[ [,] clause] ... ] new-line</span>
</pre></div>
</div>
<p>A compiler typically supports several types of pragmas, not just OpenMP pragmas.
Therefore, all OpenMP pragmas begin with the keywords <code class="code docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">omp</span></code>.
The <code class="code docutils literal notranslate"><span class="pre">directive-name</span></code> placeholder specifies the used OpenMP construct (e.g. <code class="code docutils literal notranslate"><span class="pre">parallel</span></code>) and a pragma is always followed by a new line.
Typically, a pragma affects the user code that follows it but some OpenMP pragmas are <em>stand-alone</em>.
You can span a pragma across multiple lines by using a backslash (<code class="code docutils literal notranslate"></code>) immediately followed by a new line:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp directive-name \</span>
<span class="cp">    [clause[ [,] \</span>
<span class="cp">    clause] ... ] new-line</span>
</pre></div>
</div>
</section>
<section id="parallel-construct">
<h2>Parallel construct<a class="headerlink" href="#parallel-construct" title="Permalink to this heading"></a></h2>
<p>In the earlier example, we used the <code class="code docutils literal notranslate"><span class="pre">parallel</span></code> pragma:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp parallel [clause[ [,] clause] ... ] new-line</span>
<span class="w">    </span><span class="n">structured</span><span class="o">-</span><span class="n">block</span>
</pre></div>
</div>
<p>The pragma creates a <strong>team</strong> of <strong>OpenMP threads</strong> that executes the <code class="code docutils literal notranslate"><span class="pre">structured-block</span></code> as a <strong>parallel region</strong>:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/parallel_construct.png"><img alt="../_images/parallel_construct.png" src="../_images/parallel_construct.png" style="width: 485.25px; height: 194.25px;" /></a>
</figure>
<p>The <code class="code docutils literal notranslate"><span class="pre">structured-block</span></code> region can be a single statement, like in the earlier example, or a structured block consisting of several statements:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp parallel ...</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">statement1</span><span class="p">;</span>
<span class="w">    </span><span class="n">statement2</span><span class="p">;</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>OpenMP guarantees that all threads in the team have executed the structured block before the execution continues outside the parallel region.</p>
<p>The behaviour of a parallel construct can be modified with several <strong>clauses</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="k">if</span><span class="o">([</span>parallel<span class="w"> </span>:<span class="o">]</span><span class="w"> </span>scalar-expression<span class="o">)</span>
</span><span class="hll">num_threads<span class="o">(</span>integer-expression<span class="o">)</span>
</span>default<span class="o">(</span>shared<span class="w"> </span><span class="p">|</span><span class="w"> </span>none<span class="o">)</span>
private<span class="o">(</span>list<span class="o">)</span>
firstprivate<span class="o">(</span>list<span class="o">)</span>
shared<span class="o">(</span>list<span class="o">)</span>
copyin<span class="o">(</span>list<span class="o">)</span>
reduction<span class="o">([</span>reduction-modifier<span class="w"> </span>,<span class="o">]</span><span class="w"> </span>reduction-identifier<span class="w"> </span>:<span class="w"> </span>list<span class="o">)</span>
proc_bind<span class="o">(</span>master<span class="w"> </span><span class="p">|</span><span class="w"> </span>close<span class="w"> </span><span class="p">|</span><span class="w"> </span>spread<span class="o">)</span>
allocate<span class="o">([</span>allocator<span class="w"> </span>:<span class="o">]</span><span class="w"> </span>list<span class="o">)</span>
</pre></div>
</div>
<p>We will return to some of these clauses later but for now it is sufficient to know that a parallel construct can be selectively enabled/disabled with the <code class="code docutils literal notranslate"><span class="pre">if</span></code> clause and the size of the team can be explicitly set with the <code class="code docutils literal notranslate"><span class="pre">num_threads</span></code> clause.</p>
</section>
<section id="data-sharing-rules">
<h2>Data sharing rules<a class="headerlink" href="#data-sharing-rules" title="Permalink to this heading"></a></h2>
<p>Since the structured block that follows a parallel construct is executed in parallel by a team of threads, we must make sure that the related data accesses do not cause any <strong>conflicts</strong>.
For example, the behaviour of the following program is not well defined:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos">5</span><span class="w">    </span><span class="cp">#pragma omp parallel</span>
<span class="linenos">6</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I think the number is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">++</span><span class="p">);</span>
<span class="linenos">7</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-Wall<span class="w"> </span>-fopenmp
$<span class="w"> </span>./my_program
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">2</span>.
</span>I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">8</span>.
....
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span>....
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">2</span>.
</span>....
$<span class="w"> </span>./my_program
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">2</span>.
</span>...
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">2</span>.
</span>...
</pre></div>
</div>
<p>We can make two observations:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>The order in which the <code class="code docutils literal notranslate"><span class="pre">printf</span></code> statements are executed is arbitrary. This can be a desired behaviour.</p></li>
<li><p>Some numbers are printed <strong>multiple times</strong>. This is usually an undesired behaviour.</p></li>
</ol>
</div></blockquote>
<p>The explanation is that once the team is created, the threads execute the structured block <strong>independently</strong> of each other.
This explain why the numbers are printed in an arbitrary order.
The threads also read and write the variable <code class="code docutils literal notranslate"><span class="pre">number</span></code> independently of each other which explain why some threads do not see the changes the other threads have made:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/conflict.png"><img alt="../_images/conflict.png" src="../_images/conflict.png" style="width: 529.5px; height: 238.5px;" /></a>
</figure>
<p>OpenMP implements a set of rules that define how variables behave inside OpenMP constructs.
All variables are either <code class="code docutils literal notranslate"><span class="pre">private</span></code> or <code class="code docutils literal notranslate"><span class="pre">shared</span></code>:</p>
<dl class="field-list simple">
<dt class="field-odd">Private<span class="colon">:</span></dt>
<dd class="field-odd"><p>Each thread has its own copy of the variable.</p>
</dd>
<dt class="field-even">Shared<span class="colon">:</span></dt>
<dd class="field-even"><p>All threads share the same variable.</p>
</dd>
</dl>
<p>These basic <strong>rules</strong> apply:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>All variables declared outside parallel region are shared.</p></li>
<li><p>All variables declared inside a parallel region are private.</p></li>
<li><p>Loop counters are private (in parallel loops).</p></li>
</ol>
</div></blockquote>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="linenos"> 1</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">                  </span><span class="c1">// shared</span>
</span><span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="linenos"> 4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44</span><span class="p">;</span><span class="w">             </span><span class="c1">// shared</span>
</span><span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="cp">#pragma omp parallel</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="p">{</span>
<span class="hll"><span class="linenos"> 8</span><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">          </span><span class="c1">// private</span>
</span><span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">10</span><span class="p">}</span>
</pre></div>
</div>
<p>In the above example, the variable <code class="code docutils literal notranslate"><span class="pre">number</span></code> is declared outside the parallel region and all threads therefore share the same variable.</p>
<p>We can use the <strong>private</strong> clause to turn a variable that has been declared outside a parallel region into a private variable:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="hll"><span class="linenos">5</span><span class="w">    </span><span class="cp">#pragma omp parallel private(number)</span>
</span><span class="linenos">6</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I think the number is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">++</span><span class="p">);</span>
<span class="linenos">7</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
<p>However, the end result is, once again, unexpected:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-Wall<span class="w"> </span>-fopenmp
$<span class="w"> </span>./my_program
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">0</span>.
</span><span class="hll">...
</span></pre></div>
</div>
<p>This happens because each thread has its own <code class="code docutils literal notranslate"><span class="pre">number</span></code> variable that is separate from the <code class="code docutils literal notranslate"><span class="pre">number</span></code> variable declared outside the parallel region:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/private.png"><img alt="../_images/private.png" src="../_images/private.png" style="width: 529.5px; height: 287.25px;" /></a>
</figure>
<p>The private variables do <strong>not inherit the value of the original variable</strong>.
If we want this to happen, then we must use the <strong>firstprivate</strong> clause:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="hll"><span class="linenos">5</span><span class="w">    </span><span class="cp">#pragma omp parallel firstprivate(number)</span>
</span><span class="linenos">6</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I think the number is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">++</span><span class="p">);</span>
<span class="linenos">7</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
<p>This time, the end result is as expected:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-Wall<span class="w"> </span>-fopenmp
$<span class="w"> </span>./my_program
<span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">I<span class="w"> </span>think<span class="w"> </span>the<span class="w"> </span>number<span class="w"> </span>is<span class="w"> </span><span class="m">1</span>.
</span><span class="hll">...
</span></pre></div>
</div>
<p>That is, the private variables inherits the value of the original variable:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/firstprivate.png"><img alt="../_images/firstprivate.png" src="../_images/firstprivate.png" style="width: 529.5px; height: 287.25px;" /></a>
</figure>
</section>
<section id="explicit-data-sharing-rules">
<h2>Explicit data sharing rules<a class="headerlink" href="#explicit-data-sharing-rules" title="Permalink to this heading"></a></h2>
<p>The default behaviour can be changed with the <strong>default</strong> clause:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="hll"><span class="linenos">5</span><span class="w">    </span><span class="cp">#pragma omp parallel default(none)</span>
</span><span class="linenos">6</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I think the number is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">++</span><span class="p">);</span>
<span class="linenos">7</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
<p>This tells the compiler that a programmer must explicitly set the data sharing rule for each variable.
It is therefore not surprising that the compiler produces an error indicating that the <code class="code docutils literal notranslate"><span class="pre">number</span></code> variable is not specified in the enclosing parallel region:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>gcc<span class="w"> </span>-o<span class="w"> </span>my_program<span class="w"> </span>my_program.c<span class="w"> </span>-Wall<span class="w"> </span>-fopenmp
<span class="hll">my_program.c:<span class="w"> </span>In<span class="w"> </span><span class="k">function</span><span class="w"> </span>‘main’:
</span><span class="hll">my_program.c:6:5:<span class="w"> </span>error:<span class="w"> </span>‘number’<span class="w"> </span>not<span class="w"> </span>specified<span class="w"> </span><span class="k">in</span><span class="w"> </span>enclosing<span class="w"> </span>‘parallel’
</span><span class="hll"><span class="w">    </span><span class="m">6</span><span class="w"> </span><span class="p">|</span><span class="w">     </span>printf<span class="o">(</span><span class="s2">&quot;I think the number is %d.\n&quot;</span>,<span class="w"> </span>number++<span class="o">)</span><span class="p">;</span>
</span><span class="hll"><span class="w">      </span><span class="p">|</span><span class="w">     </span>^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span><span class="hll">my_program.c:5:13:<span class="w"> </span>error:<span class="w"> </span>enclosing<span class="w"> </span>‘parallel’
</span><span class="hll"><span class="w">    </span><span class="m">5</span><span class="w"> </span><span class="p">|</span><span class="w">     </span><span class="c1">#pragma omp parallel default(none)</span>
</span><span class="hll"><span class="w">      </span><span class="p">|</span>
</span></pre></div>
</div>
<p>We can now set the <code class="code docutils literal notranslate"><span class="pre">number</span></code> variable to firstprivate:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">4</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="hll"><span class="linenos">5</span><span class="w">    </span><span class="cp">#pragma omp parallel default(none) firstprivate(number)</span>
</span><span class="linenos">6</span><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;I think the number is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">++</span><span class="p">);</span>
<span class="linenos">7</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">8</span><span class="p">}</span>
</pre></div>
</div>
<p>It is <strong>generally recommended</strong> that a programmer sets the data sharing rules explicitly as this forces them to think about the data sharing rules.
It is also advisable to declare all private variables inside the structured block.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../setup/" class="btn btn-neutral float-left" title="Introduction to Kebnekaise" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../openmp-basics2/" class="btn btn-neutral float-right" title="Introduction to OpenMP (part 2)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>